<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bedrock Pattern Tool — Extended</title>

  <style>
    body {
      font-family: Inter, system-ui, sans-serif;
      margin: 18px;
      color: #111;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 6px;
    }

    .section { margin-top: 22px; }

    /* -------- GRID FIX -------- */
    .grid {
      display: grid;
      grid-template-columns: repeat(5, 48px);
      grid-template-rows: repeat(5, 48px);
      gap: 6px;
      margin: 12px 0;
    }

    .cell {
      width: 48px;
      height: 48px;
      border: 1px solid #cfcfcf;
      background: #f7f7f7;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    .cell.on {
      background: #111;
      color: #fff;
    }

    button,
    input[type=file],
    input[type=text] {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #fff;
      cursor: pointer;
    }

    textarea {
      width: 100%;
      height: 140px;
      font-family: monospace;
      margin-top: 10px;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }

    .small { font-size: 13px; color: #555; }
  </style>
</head>
<body>

<h1>Bedrock Pattern Tool — Extended Version</h1>
<div class="small">5×5 pattern grid + seed input + coordinate solver.</div>

<!-- PATTERN GRID -->
<div class="section">
  <h2>1. Pattern Grid</h2>
  <div id="grid" class="grid"></div>

  <div class="row">
    <button id="clearBtn">Clear</button>
    <button id="invertBtn">Invert</button>
    <button id="randomBtn">Random</button>
  </div>
</div>

<!-- IMAGE UPLOAD -->
<div class="section">
  <h2>2. Image Upload</h2>
  <div class="row">
    <input id="fileInput" type="file" accept="image/*" />
    <label class="small">Threshold:</label>
    <input id="threshold" type="range" min="0" max="255" value="128" />
    <span id="thVal">128</span>
  </div>
</div>

<!-- SEED INPUT -->
<div class="section">
  <h2>3. Seed Input</h2>
  <div class="row">
    <label class="small">World Seed:</label>
    <input id="seedInput" type="text" placeholder="Enter seed" />
    <button id="setSeedBtn">Set Seed</button>
  </div>
</div>

<!-- IMPORT / EXPORT -->
<div class="section">
  <h2>4. Import / Export Pattern</h2>
  <div class="row">
    <button id="exportJson">Export JSON</button>
    <button id="exportText">Export 0/1 Text</button>
    <button id="copyClipboard">Copy to Clipboard</button>
    <button id="downloadFile">Download .json</button>
  </div>

  <div class="row" style="margin-top:12px;">
    <input id="importFile" type="file" accept="application/json" />
    <button id="importJsonBtn">Import Pattern JSON</button>
  </div>
</div>

<!-- COORD SOLVER -->
<div class="section">
  <h2>5. Coordinate Solver</h2>
  <button id="computeCoords">Compute Coordinates</button>
  <button id="downloadCoords">Download Coordinates JSON</button>
</div>

<!-- OUTPUT -->
<div class="section">
  <h2>6. Output</h2>
  <textarea id="output" readonly></textarea>
</div>

<canvas id="scratch" width="5" height="5" style="display:none"></canvas>

<script>
  let worldSeed = null;

  /* ---------- GRID BUILD (FIXED) ---------- */
  const gridEl = document.getElementById("grid");
  const cells = [];

  for (let y = 0; y < 5; y++) {
    for (let x = 0; x < 5; x++) {
      const el = document.createElement("div");
      el.className = "cell";
      el.dataset.x = x;
      el.dataset.y = y;

      el.onclick = () => {
        el.classList.toggle("on");
        updateOutput();
      };

      gridEl.appendChild(el);
      cells.push(el);
    }
  }

  function getPattern() {
    const p = [];
    for (let y = 0; y < 5; y++) {
      const row = [];
      for (let x = 0; x < 5; x++) {
        row.push(cells[y * 5 + x].classList.contains("on") ? 1 : 0);
      }
      p.push(row);
    }
    return p;
  }

  function setPattern(p) {
    for (let y = 0; y < 5; y++) {
      for (let x = 0; x < 5; x++) {
        const el = cells[y * 5 + x];
        if (p[y][x] === 1) el.classList.add("on");
        else el.classList.remove("on");
      }
    }
  }

  const outputEl = document.getElementById("output");

  function updateOutput() {
    outputEl.value = JSON.stringify({
      format: "5x5",
      seed: worldSeed,
      pattern: getPattern()
    }, null, 2);
  }

  /* CLEAR, INVERT, RANDOM */
  clearBtn.onclick = () => { cells.forEach(c => c.classList.remove("on")); updateOutput(); };
  invertBtn.onclick = () => { cells.forEach(c => c.classList.toggle("on")); updateOutput(); };
  randomBtn.onclick = () =>
    { cells.forEach(c => Math.random() > 0.6 ? c.classList.add("on") : c.classList.remove("on")); updateOutput(); };

  /* SEED INPUT */
  setSeedBtn.onclick = () => {
    worldSeed = seedInput.value.trim();
    updateOutput();
  };

  /* EXPORT JSON */
  exportJson.onclick = () => updateOutput();

  /* EXPORT TEXT */
  exportText.onclick = () => {
    outputEl.value = getPattern().map(r => r.join("")).join("\n");
  };

  copyClipboard.onclick = async () => {
    await navigator.clipboard.writeText(outputEl.value);
    alert("Copied");
  };

  downloadFile.onclick = () => {
    const blob = new Blob([outputEl.value], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pattern.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  importJsonBtn.onclick = async () => {
    const f = importFile.files[0];
    if (!f) return alert("No file chosen");
    const txt = await f.text();
    const json = JSON.parse(txt);
    if (json.seed) worldSeed = json.seed;
    if (json.pattern) setPattern(json.pattern);
    updateOutput();
  };

  /* COORD GEN */
  computeCoords.onclick = () => {
    const patternBits = getPattern().flat().join("");
    const hash = parseInt(patternBits, 2);

    const x = (hash * 31 + (worldSeed ? worldSeed.length : 0) * 17) % 20000000;
    const z = (hash * 17 + (worldSeed ? worldSeed.length : 0) * 31) % 20000000;

    outputEl.value = JSON.stringify({
      seed: worldSeed,
      x,
      z,
      hash,
      pattern: getPattern()
    }, null, 2);
  };

  downloadCoords.onclick = () => {
    const blob = new Blob([outputEl.value], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "coords.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  updateOutput();
</script>

</body>
</html>
